<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard de Análise de Contratos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <style>
    /* Estilos Gerais e das Abas */
    #tabelaContratos tbody tr:hover, .mini-table tbody tr:hover { background-color: #E6ECEF !important; cursor: pointer; }
    #modalDetalhes .modal-inner, #modalEditar .modal-inner { max-height: 80vh; overflow-y: auto; max-width: 600px; }
    #filtros select { max-height: 180px; overflow-y: auto; min-width: 100px; }
    .hidden { display: none !important; }
    .nav-btn.active { background: #1E4069; color: #FFFFFF; }
    .nav-btn { background: #FFFFFF; color: #1E4069; border: 1px solid #1E4069; }
    .nav-btn:hover { background: #4DA8DA; color: #FFFFFF; }
    #buscaUniversal { border: 1px solid #1E4069; border-radius: 0.375rem; padding: 0.5rem; width: 100%; max-width: 320px; font-size: 1rem; margin-bottom: 1rem; }
    #buscaUniversal:focus { outline: none; border-color: #4DA8DA; box-shadow: 0 0 0 2px #4DA8DA44; }
    @media (max-width: 640px) { #buscaUniversal { max-width: 100%; } }
    /* Loading Spinner */
    #loadingOverlay { background: rgba(255,255,255,0.7); position: fixed; z-index: 1000; inset: 0; display: flex; align-items: center; justify-content: center; }
    .spinner { border: 6px solid #E6ECEF; border-top: 6px solid #1E4069; border-radius: 50%; width: 56px; height: 56px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
    /* Estilo para Aba de Duplicados */
    .diferente { background-color: #FFF9CC; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <div id="loadingOverlay" class="hidden">
    <div>
      <div class="spinner mx-auto"></div>
      <div id="loadingText" class="text-[#1E4069] text-lg mt-3 text-center font-bold">Carregando contratos...</div>
    </div>
  </div>
  <header class="bg-[#1E4069] text-white p-4 shadow flex items-center justify-between">
    <h1 class="text-2xl font-bold">Dashboard de Análise de Contratos</h1>
    <div class="flex items-center gap-2">
      <button id="navTabela" class="nav-btn rounded px-4 py-2 font-medium active" aria-current="page" type="button">Tabela</button>
      <button id="navGraficos" class="nav-btn rounded px-4 py-2 font-medium" type="button">Gráficos</button>
      <button id="navDuplicados" class="nav-btn rounded px-4 py-2 font-medium" type="button">Duplicados</button>
    </div>
  </header>
  <main class="flex-1 p-6">
        <div id="painelTabela">
      <div id="painelFiscaisCFISCON"></div>
      <section id="avisosVencimento" class="mb-6"></section>
      <section class="bg-white p-6 rounded shadow mb-6">
        <div class="mb-4">
          <label for="buscaUniversal" class="block text-sm font-semibold mb-1">Busca Universal</label>
          <input type="text" id="buscaUniversal" placeholder="Digite nome, CNPJ, objeto, número do contrato ou qualquer termo...">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4" id="filtros">
          <div><label class="block text-sm font-semibold mb-1">Ano do Contrato</label><select id="filtroAnoContrato" class="w-full border rounded px-2 py-1"></select></div>
          <div><label class="block text-sm font-semibold mb-1">Final Vigência</label><select id="filtroFinalVigencia" class="w-full border rounded px-2 py-1"><option value="">Todas</option><option value="30">Vencem em até 30 dias</option><option value="60">Vencem em até 60 dias</option><option value="90">Vencem em até 90 dias</option><option value="120">Vencem em até 120 dias</option><option value="150">Vencem em até 150 dias</option><option value="180">Vencem em até 180 dias</option></select></div>
          <div><label class="block text-sm font-semibold mb-1">Tipo de Objeto</label><select id="filtroTipoObjeto" class="w-full border rounded px-2 py-1"><option value="">Todos</option><option value="Compras">Compras</option><option value="Outros Serviços">Outros Serviços</option><option value="Obras e Serviços de Engenharia">Obras e Serviços de Engenharia</option></select></div>
          <div><label class="block text-sm font-semibold mb-1">Fiscal(is)</label><select id="filtroFiscal" class="w-full border rounded px-2 py-1"></select></div>
          <div><label class="block text-sm font-semibold mb-1">Situação</label><select id="filtroSituacao" class="w-full border rounded px-2 py-1"></select></div>
        </div>
        <div class="mt-4"><button id="limparFiltros" class="bg-[#E6ECEF] hover:bg-[#4DA8DA] text-[#333333] px-4 py-2 rounded">Limpar Filtros</button></div>
      </section>
      <section class="bg-white p-6 rounded shadow">
        <h2 class="text-lg font-bold mb-4">Tabela de Contratos</h2>
        <div class="overflow-x-auto"><table id="tabelaContratos" class="display w-full"></table></div>
      </section>
    </div>
        <div id="painelGraficos" class="hidden">
      <section class="bg-white p-6 rounded shadow mb-6">
        <h2 class="text-lg font-bold mb-4">Gráficos</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <div><h3 class="font-semibold mb-2 text-sm text-gray-700">Situação dos Contratos</h3><canvas id="graficoSituacao"></canvas></div>
          <div><h3 class="font-semibold mb-2 text-sm text-gray-700">Contratos por Ano</h3><canvas id="graficoAno"></canvas></div>
          <div><h3 class="font-semibold mb-2 text-sm font-bold text-gray-700">Prazos dos Contratos</h3><canvas id="graficoPrazo"></canvas></div>
        </div>
      </section>
    </div>
        <div id="painelDuplicados" class="hidden">
      <section id="controles-duplicados" class="bg-white p-6 rounded shadow mb-6">
        <div class="border-b pb-4 mb-4"><h2 class="text-lg font-bold text-gray-800">1. Critérios para Duplicidade</h2><p class="text-sm text-gray-600 mt-1">Selecione os campos que devem ser idênticos para um contrato ser considerado um duplicado.</p></div>
        <div id="criterios-selecao" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
        <div class="mt-6 text-center"><button id="verificarDuplicados" class="bg-[#1E4069] text-white hover:bg-[#4DA8DA] px-6 py-2 rounded font-semibold">Verificar Duplicados</button></div>
      </section>
      <section id="resultados-duplicados" class="bg-white p-6 rounded shadow">
        <div class="border-b pb-4 mb-4"><h2 class="text-lg font-bold text-gray-800">2. Resultados da Análise</h2></div>
        <div id="resultados-conteudo" class="text-center text-gray-500"><p>Aguardando a verificação...</p></div>
      </section>
    </div>
  </main>
    <div id="modalDetalhes" class="fixed inset-4 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-modal="true" role="dialog">
    <div class="bg-white rounded shadow-lg modal-inner p-6 relative">
      <button id="fecharModalDetalhes" class="absolute top-2 right-2 text-gray-400 hover:text-[#F4A261] text-2xl" title="Fechar" aria-label="Fechar"><span aria-hidden="true">×</span></button>
      <h3 class="text-lg font-bold mb-4" id="modalTituloDetalhes"></h3>
      <div id="modalConteudoDetalhes" class="space-y-2 text-sm"></div>
    </div>
  </div>
    <div id="modalEditar" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center hidden" aria-modal="true" role="dialog">
    <div class="bg-white rounded shadow-lg modal-inner p-6 relative w-full">
        <button id="fecharModalEditar" class="absolute top-2 right-2 text-gray-400 hover:text-red-500 text-3xl" title="Fechar" aria-label="Fechar"><span aria-hidden="true">&times;</span></button>
        <h3 class="text-xl font-bold mb-4" id="modalTituloEditar">Editando Contrato</h3>
        <form id="formEditarContrato" class="space-y-3">
            <div id="form-fields-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div class="mt-6 pt-4 border-t flex justify-end items-center gap-3">
                <p id="respostaApi" class="text-sm font-medium mr-auto"></p>
                <button type="button" id="cancelarEdicao" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded">Cancelar</button>
                <button type="submit" id="salvarAlteracoes" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-semibold">Salvar Alterações</button>
            </div>
        </form>
    </div>
   </div>
  <footer class="text-center text-gray-500 text-sm py-4">©️ 2025 Dashboard de Contratos - Exemplo Interativo</footer>
<script>
  // --- VARIÁVEIS GLOBAIS ---
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0URMfEf9HGcXuuCHgKFRfOEx7t_zR_lSMS7xNiFjPe17ZwH3u5Tw8duT1AwCsktqrY3CA3slAKxVL/pub?output=csv";
  const SCRIPT_API_URL = "https://script.google.com/macros/s/AKfycbwEVeDAHsBnqPc8RvGLZw5B0avSsmo2b_nmq5u2lPtFIJef9iVQw8UhZLFuxi6Xiy5D/exec";
  let contratos = [];
  let contratosFiltrados = [];
  let tabela = null;
  let chartSituacao = null, chartAno = null, chartPrazo = null;
  let termoBuscaUniversal = "";

  // --- MAPEAMENTO DE COLUNAS E LISTA DE FISCAIS ---
  const fiscaisCFISCON_EXIBIVEL = [ { norm: "CARMEN LUCIA ULGUIM CHAGAS PADOIN", exib: "Carmen Lucia Ulguim Chagas Padoin" }, { norm: "MARCIA BEHEREGARAY ARGOLLO MENDES", exib: "Marcia Beheregaray Argollo Mendes" }, { norm: "MAURICIO LEANDRO BORGES ROSA", exib: "Mauricio Leandro Borges Rosa" }, { norm: "OTAVIO DA SILVA AFONSO", exib: "Otavio da Silva Afonso" }, { norm: "ARIADNE SILVEIRA TUPY ASSU", exib: "Ariadne Silveira Tupy Assu" }, { norm: "FERNANDA DA ROSA PEDERNEIRAS", exib: "Fernanda Da Rosa Pederneiras" }, { norm: "FELIPE PAIVA CURI", exib: "Felipe Paiva Curi" } ];
  const colunaMap = { 'rowid': 'RowID', 'instrumento': 'Instrumento', 'n contrato': 'N° Contrato', 'nº contrato': 'N° Contrato', 'ano contrato': 'AnoContrato', 'contratado': 'Contratado', 'cpfcnpj': 'CPF/CNPJ', 'descricao do objeto': 'Descrição do Objeto', 'valor contrato': 'ValorContrato', 'nº ter aditivo apostilamento': 'Nº Ter. Aditivo Apostilamento', 'valor com alteracoes': 'Valor com Alterações', 'assinatura': 'Assinatura', 'inicio vigencia': 'Início Vigência', 'final vigencia': 'Final Vigência', 'situacao': 'Situação', 'n processo': 'N° Processo', 'ano processo': 'Ano Processo', 'gestores': 'Gestor(es)', 'natureza objeto': 'Natureza Objeto', 'objeto': 'Objeto', 'suplentes': 'Suplente(s)', 'fiscais': 'Fiscal(is)', 'prazo': 'Prazo', 'prazo maximo vigencia': 'Prazo Máximo Vigência', 'prorrogacao prazo': 'Prorrogação Prazo', 'lei': 'Lei', 'obs': 'OBS:' };

  // --- FUNÇÕES AUXILIARES E DE MANIPULAÇÃO DE DADOS ---
  function normalizeCol(str) { return (str||'').normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[\r\n]+/g, " ").replace(/\s+/g, " ").trim().replace(/[^a-z0-9 ]/gi, "").toLowerCase(); }
  function excelSerialToDate(serial) { var utc_days = Math.floor(serial - 25569); var utc_value = utc_days * 86400; var date_info = new Date(utc_value * 1000); return new Date(date_info.getTime() + (date_info.getTimezoneOffset() * 60 * 1000)); }
  function parseDate(dateStr) { if (!dateStr) return null; if (typeof dateStr === 'number' || (!isNaN(dateStr) && String(dateStr).length >= 5 && String(dateStr).length <= 6)) { return excelSerialToDate(Number(dateStr)); } if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) { const [d, m, y] = dateStr.split('/'); return new Date(`${y}-${m}-${d}T00:00:00`); } if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) { return new Date(dateStr); } let d = new Date(dateStr); return isNaN(d.getTime()) ? null : d; }
  function formatDateBR(dateStr) { const d = parseDate(dateStr); if (!d) return ""; return d.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); }
  function prazoMeses(inicio, fim) { const d1 = parseDate(inicio); const d2 = parseDate(fim); if (!d1 || !d2) return ""; let months = (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth()); if (d2.getDate() >= d1.getDate()) { months++; } return months > 0 ? `${months} mês${months > 1 ? 'es' : ''}` : ""; }
  function diasAteVencimento(finalVigencia) { let dataFinal = parseDate(finalVigencia); if (!dataFinal) return null; let hoje = new Date(); hoje.setHours(0,0,0,0); return Math.ceil((dataFinal - hoje) / (1000 * 60 * 60 * 24)); }
  function formatDiasVencimento(finalVigencia) { let dias = diasAteVencimento(finalVigencia); if (dias === null) return ""; if (dias === 0) return "vence hoje"; if (dias === 1) return "vence em 1 dia"; if (dias > 1) return `vence em ${dias} dias`; if (dias < 0) return "vencido"; return ""; }
  function showLoading(show = true, text = "Carregando contratos...") { document.getElementById('loadingText').textContent = text; document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
  function agruparSituacao(sit) { const norm = (sit || "").toLowerCase(); return norm.includes("vigente") ? "Vigente" : "Não Vigente"; }
  function mapearTipoObjeto(objeto) { const o = (objeto || "").toLowerCase(); if (o.includes("fornecimento") || o.includes("material") || o.includes("compra")) return "Compras"; if (o.includes("obra") || o.includes("engenharia")) return "Obras e Serviços de Engenharia"; return "Outros Serviços"; }
  
  // --- FUNÇÕES DE RENDERIZAÇÃO E ATUALIZAÇÃO DA UI ---
  function fillSelectOptions(selectId, array, field) { const select = document.getElementById(selectId); const values = [...new Set(array.map(item => item[field]).filter(Boolean))].sort(); let options = `<option value="">Todos</option>`; values.forEach(val => { options += `<option value="${val}">${val}</option>`; }); select.innerHTML = options; }
  function fillSelectOptionsSituacao(selectId, array) { const select = document.getElementById(selectId); const values = [...new Set(array.map(item => agruparSituacao(item['Situação'])))]; select.innerHTML = `<option value="">Todas</option>${values.map(v => `<option value="${v}">${v}</option>`).join('')}`; }
  function contratoTemFiscalCFISCON(contrato) { return (contrato['Fiscal(is)'] || '').split(/[,;\n]+/).some(f => fiscaisCFISCON_EXIBIVEL.some(fiscal => fiscal.exib.toLowerCase().trim() === f.toLowerCase().trim())); }
  
  // --- FUNÇÕES PRINCIPAIS (APLICAR FILTROS, ATUALIZAR TABELA, ETC.) ---
  function aplicarFiltros() {
    const ano = document.getElementById('filtroAnoContrato').value;
    const vig = document.getElementById('filtroFinalVigencia').value;
    const tipoObjeto = document.getElementById('filtroTipoObjeto').value;
    const fiscal = document.getElementById('filtroFiscal').value;
    const situacao = document.getElementById('filtroSituacao').value;
    const termoBusca = document.getElementById('buscaUniversal').value.toLowerCase();

    contratosFiltrados = contratos.filter(c => {
        if (ano && String(c.AnoContrato) !== ano) return false;
        if (situacao && agruparSituacao(c.Situação) !== situacao) return false;
        if (tipoObjeto && mapearTipoObjeto(c.Objeto) !== tipoObjeto) return false;
        if (fiscal && !(c['Fiscal(is)'] || '').toLowerCase().includes(fiscal.toLowerCase())) return false;
        if (vig) {
            const dias = diasAteVencimento(c['Final Vigência']);
            if (dias === null || dias < 0 || dias > parseInt(vig)) return false;
        }
        if (termoBusca && !Object.values(c).some(val => String(val).toLowerCase().includes(termoBusca))) return false;
        return true;
    });
    atualizarTabela();
    atualizarAvisosVencimento();
    // renderPainelFiscaisCFISCON(); // Adicionar se a função for recriada
    desenharGraficos();
  }

  function atualizarTabela() {
    const columns = [
        { title: "N° Contrato", data: "N° Contrato" }, { title: "Ano", data: "AnoContrato" }, { title: "Contratado", data: "Contratado" }, { title: "Final Vigência", data: "Final Vigência", render: data => formatDateBR(data) }, { title: "Prazo", data: null, render: (data, type, row) => prazoMeses(row['Início Vigência'], row['Final Vigência']) }, { title: "Vence em", data: "Final Vigência", render: data => formatDiasVencimento(data) }, { title: "Situação", data: "Situação" },
        { title: "Ações", data: null, orderable: false, render: (data, type, row) => {
            const originalIndex = contratos.findIndex(c => c.RowID === row.RowID);
            return `<div class="flex gap-1">
                      <button class="ver-detalhes bg-[#1E4069] hover:bg-[#4DA8DA] text-white px-2 py-1 rounded text-xs" data-idx="${originalIndex}" title="Ver detalhes">Detalhes</button>
                      <button class="editar-contrato bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded text-xs" data-idx="${originalIndex}" title="Editar contrato">Editar</button>
                    </div>`;
        }}
    ];
    if (tabela) { tabela.clear().destroy(); $('#tabelaContratos').empty(); }
    tabela = $('#tabelaContratos').DataTable({ data: contratosFiltrados, columns, pageLength: 10, language: { url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json" }, createdRow: (row, data) => { if (contratoTemFiscalCFISCON(data)) $(row).css('font-weight', 'bold'); const dias = diasAteVencimento(data['Final Vigência']); if (dias!==null) { if(dias < 30) $(row).css('background-color', '#FFCCCC'); else if (dias < 60) $(row).css('background-color', '#FFF9CC'); } } });
    $('#tabelaContratos tbody').off('click').on('click', '.ver-detalhes', function(e){ e.stopPropagation(); mostrarDetalhesContrato(contratos[$(this).data('idx')]); });
    $('#tabelaContratos tbody').on('click', '.editar-contrato', function(e){ e.stopPropagation(); abrirModalEdicao(contratos[$(this).data('idx')]); });
  }
  
  function atualizarAvisosVencimento() { /* Adicionar a lógica completa dos avisos aqui, se necessário */ document.getElementById('avisosVencimento').innerHTML = ''; }

  // --- FUNÇÕES DE MODAL (DETALHES E EDIÇÃO) ---
  function mostrarDetalhesContrato(contrato) { let html = `<table class="min-w-full text-left border border-[#E6ECEF] text-xs"><tbody>`; for(const [k,v] of Object.entries(contrato)){ if(k === 'RowID') continue; let val = v; if (k === 'Final Vigência' || k === 'Início Vigência') val = formatDateBR(v); html += `<tr class="border-b border-[#E6ECEF]"><th class="py-1 px-2 bg-[#E6ECEF] font-semibold w-40">${k}</th><td class="py-1 px-2">${val||''}</td></tr>`; } html += `<tr><th class="py-1 px-2 bg-[#E6ECEF] font-semibold w-40">Prazo (auto)</th><td class="py-1 px-2">${prazoMeses(contrato['Início Vigência'], contrato['Final Vigência'])}</td></tr>`; html += `<tr><th class="py-1 px-2 bg-[#E6ECEF] font-semibold w-40">Vence em</th><td class="py-1 px-2">${formatDiasVencimento(contrato['Final Vigência'])}</td></tr></tbody></table>`; document.getElementById('modalTituloDetalhes').innerText = `Detalhes: ${contrato['N° Contrato'] || ''}`; document.getElementById('modalConteudoDetalhes').innerHTML = html; document.getElementById('modalDetalhes').classList.remove('hidden'); }
  function abrirModalEdicao(contrato) {
    const container = document.getElementById('form-fields-container');
    container.innerHTML = `<input type="hidden" id="edit-RowID" name="RowID" value="${contrato.RowID}">` +
    Object.values(colunaMap).filter(h => h !== 'RowID').map(header => {
        const value = contrato[header] || '';
        const isTextarea = header.toLowerCase().includes('objeto') || header.toLowerCase().includes('obs');
        return `<div><label for="edit-${header}" class="block text-sm font-medium text-gray-700">${header}</label>${isTextarea ? `<textarea id="edit-${header}" name="${header}" rows="3" class="mt-1 block w-full input-field">${value}</textarea>` : `<input type="text" id="edit-${header}" name="${header}" value="${value}" class="mt-1 block w-full input-field">`}</div>`;
    }).join('');
    document.getElementById('modalTituloEditar').innerText = `Editando Contrato: ${contrato['N° Contrato']}`;
    document.getElementById('modalEditar').classList.remove('hidden');
  }

  // --- LÓGICA DE CARREGAMENTO E PROCESSAMENTO DE DADOS ---
  function processData(data) { contratos = data.map(row => { let obj = {}; for (const k in row) { let norm = normalizeCol(k); let key = colunaMap[norm] || k.trim(); if(key){ obj[key] = typeof row[k] === 'string' ? row[k].trim() : row[k]; } } return obj; }); aplicarFiltros(); fillSelectOptions('filtroAnoContrato', contratos, 'AnoContrato'); fillSelectOptionsSituacao('filtroSituacao', contratos); /* Adicionar outros filtros */ }
  function carregarContratosPlanilha() { showLoading(true); Papa.parse(SHEET_CSV_URL + '&_=' + new Date().getTime(), { download: true, header: true, skipEmptyLines: true, complete: res => { showLoading(false); if (!res.data) { alert('Erro: Não foi possível carregar dados.'); return; } processData(res.data); desenharGraficos(); }, error: err => { showLoading(false); alert('Erro ao carregar dados da planilha!'); console.error(err); } }); }

  // --- LÓGICA VERIFICADOR DE DUPLICADOS ---
  const CRITERIOS_SUGERIDOS = [ { id: 'N° Processo', label: 'N° Processo', checked: true }, { id: 'Ano Processo', label: 'Ano Processo', checked: true }, { id: 'Contratado', label: 'Contratado', checked: true }, { id: 'CPF/CNPJ', label: 'CPF/CNPJ', checked: false }, { id: 'Objeto', label: 'Objeto', checked: true } ];
  function renderizarCriterios() { const container = document.getElementById('criterios-selecao'); container.innerHTML = CRITERIOS_SUGERIDOS.map(c => `<label class="flex items-center space-x-2 p-2 rounded hover:bg-gray-100 cursor-pointer"><input type="checkbox" name="criterio" value="${c.id}" class="h-4 w-4 rounded border-gray-300 text-[#1E4069] focus:ring-[#1E4069]" ${c.checked ? 'checked' : ''}><span class="text-sm font-medium text-gray-700">${c.label}</span></label>`).join(''); }
  function verificarDuplicados() { const criterios = Array.from(document.querySelectorAll('input[name="criterio"]:checked')).map(cb => cb.value); if(criterios.length === 0) { alert('Selecione ao menos um critério.'); return; } showLoading(true, "Verificando..."); const grupos = new Map(); contratos.forEach(c => { const chave = criterios.map(crit => (c[crit]||'').toString().trim().toLowerCase()).join('||'); if(chave) { if(!grupos.has(chave)) grupos.set(chave, []); grupos.get(chave).push(c); } }); const duplicados = Array.from(grupos.values()).filter(g => g.length > 1); setTimeout(() => { renderizarResultadosDuplicados(duplicados, criterios); showLoading(false); }, 500); }
  function renderizarResultadosDuplicados(grupos, criterios) { const container = document.getElementById('resultados-conteudo'); if(grupos.length === 0) { container.innerHTML = `<div class="text-center py-8"><svg class="mx-auto h-12 w-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><h3 class="mt-2 text-lg font-medium text-gray-900">Nenhum duplicado encontrado!</h3></div>`; return; } container.innerHTML = `<p class="text-left text-sm text-gray-600 mb-4">Encontrados <strong>${grupos.length}</strong> grupos de contratos duplicados.</p>` + grupos.map((grupo, idx) => { const diffs = new Set(); Object.keys(grupo[0]).forEach(k => { if(new Set(grupo.map(g => g[k])).size > 1) diffs.add(k); }); return `<div class="border rounded-lg shadow-sm mb-6 overflow-hidden"><div class="bg-gray-50 p-3 border-b"><h4 class="font-bold text-md text-[#1E4069]">${grupo[0]['Contratado'] || `Grupo ${idx+1}`} (${grupo.length})</h4></div><div class="overflow-x-auto"><table class="min-w-full text-sm"><thead>...</thead><tbody>${grupo.map(c => `<tr><td class="py-2 px-3 ${diffs.has('N° Contrato')?'diferente':''}">${c['N° Contrato']||''}</td>...</tr>`).join('')}</tbody></table></div></div>`; }).join(''); /* Código da tabela simplificado para brevidade */ }

  // --- INICIALIZAÇÃO E EVENT LISTENERS ---
  document.addEventListener("DOMContentLoaded", function(){
    const navButtons = { tabela: document.getElementById('navTabela'), graficos: document.getElementById('navGraficos'), duplicados: document.getElementById('navDuplicados') };
    const panels = { tabela: document.getElementById('painelTabela'), graficos: document.getElementById('painelGraficos'), duplicados: document.getElementById('painelDuplicados') };
    function switchTab(activeTab) { Object.keys(panels).forEach(key => { panels[key].classList.toggle('hidden', key !== activeTab); navButtons[key].classList.toggle('active', key === activeTab); }); if (activeTab === 'graficos') desenharGraficos(); }
    Object.keys(navButtons).forEach(key => navButtons[key].addEventListener('click', () => switchTab(key)));
    
    document.getElementById('buscaUniversal').addEventListener('input', aplicarFiltros);
    ['filtroAnoContrato','filtroFinalVigencia','filtroTipoObjeto','filtroFiscal','filtroSituacao'].forEach(id => { document.getElementById(id)?.addEventListener('change', aplicarFiltros); });
    document.getElementById('limparFiltros').addEventListener('click', () => { document.getElementById('filtros').querySelectorAll('select').forEach(s => s.value = ''); document.getElementById('buscaUniversal').value = ''; aplicarFiltros(); });

    document.getElementById('fecharModalDetalhes').onclick = () => document.getElementById('modalDetalhes').classList.add('hidden');
    document.getElementById('fecharModalEditar').onclick = () => document.getElementById('modalEditar').classList.add('hidden');
    document.getElementById('cancelarEdicao').onclick = () => document.getElementById('modalEditar').classList.add('hidden');

    document.getElementById('formEditarContrato').addEventListener('submit', async function(e){ e.preventDefault(); const btn = document.getElementById('salvarAlteracoes'); const apiMsg = document.getElementById('respostaApi'); btn.disabled = true; btn.textContent = 'Salvando...'; apiMsg.textContent = ''; const data = Object.fromEntries(new FormData(e.target).entries()); try { const res = await fetch(SCRIPT_API_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' }}); const result = await res.json(); if(result.status !== 'sucesso') throw new Error(result.mensagem); apiMsg.style.color = 'green'; apiMsg.textContent = result.mensagem; setTimeout(() => { document.getElementById('modalEditar').classList.add('hidden'); carregarContratosPlanilha(); }, 1500); } catch (err) { apiMsg.style.color = 'red'; apiMsg.textContent = 'Erro: ' + err.message; } finally { btn.disabled = false; btn.textContent = 'Salvar Alterações'; } });

    renderizarCriterios();
    document.getElementById('verificarDuplicados').addEventListener('click', verificarDuplicados);
    carregarContratosPlanilha();
  });

  function desenharGraficos() {
    if(!contratosFiltrados || contratosFiltrados.length === 0) return;
    Chart.register(ChartDataLabels);
    const renderChart = (chartInstance, ctx, type, data, options) => { if(chartInstance) chartInstance.destroy(); return new Chart(ctx, { type, data, options }); };
    const baseOptions = { responsive: true, plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', font: { weight: 'bold' } } } };
    const sitData = contratosFiltrados.reduce((acc, c) => { const g = agruparSituacao(c.Situação); acc[g] = (acc[g] || 0) + 1; return acc; }, {});
    chartSituacao = renderChart(chartSituacao, 'graficoSituacao', 'pie', { labels: Object.keys(sitData), datasets: [{ data: Object.values(sitData), backgroundColor: ['#1E4069', '#4DA8DA'] }] }, baseOptions);
    const anoData = contratosFiltrados.reduce((acc, c) => { if(c.AnoContrato) { acc[c.AnoContrato] = (acc[c.AnoContrato] || 0) + 1; } return acc; }, {});
    chartAno = renderChart(chartAno, 'graficoAno', 'bar', { labels: Object.keys(anoData).sort(), datasets: [{ label: 'Contratos', data: Object.values(anoData), backgroundColor: '#1E4069' }] }, baseOptions);
    // Adicionar lógica do gráfico de prazo se necessário
 }
</script>
</body>
</html>
